stages:
    - carbonbuild
    - yarninstall
    - yarntest
    - yarnbuild
    - nginxbuild

variables:
    V_NUM: "v0.0.1"
    CARBON_URL: "code.ornl.gov:4567/rse/datastreams/nuclear-datastreams/frontend/carbon"
    NGINX_URL: "code.ornl.gov:4567/rse/datastreams/nuclear-datastreams/frontend/nginx"   
    
carbonbuild:
    stage: carbonbuild
    before_script:
        - sudo systemctl stop docker
        - sudo rm -rf /var/lib/docker
        - sudo systemctl start docker
        - sudo docker rmi -f $CARBON_URL/$CI_COMMIT_REF_NAME:$V_NUM
    script:
        - docker build -f Dockerfile-carbon -t $CARBON_URL/$CI_COMMIT_REF_NAME:$V_NUM .
        - docker login --username=$CI_REGISTRY_USER --password=$CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker push $CARBON_URL/$CI_COMMIT_REF_NAME:$V_NUM
    after_script:
        - sudo chown -R gitlab-runner .
    tags:
        - rse-nds-builder

yarninstall:
    stage: yarninstall
    artifacts:
        untracked: true
    before_script:
        - sudo rm -rf data-ingestion-ui/node_modules/
    script:
        - docker login --username=$CI_REGISTRY_USER --password=$CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker pull $CARBON_URL/$CI_COMMIT_REF_NAME:$V_NUM
        - docker run -v $PWD:/app $CARBON_URL/$CI_COMMIT_REF_NAME:$V_NUM bash -c "yarn install"
    after_script:
        - sudo chown -R gitlab-runner .
    tags:
        - rse-nds-builder

yarntest:
    stage: yarntest
    dependencies: 
        - yarninstall
    script:
        - docker login --username=$CI_REGISTRY_USER --password=$CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker pull $CARBON_URL/$CI_COMMIT_REF_NAME:$V_NUM
        - docker run -v $PWD:/app $CARBON_URL/$CI_COMMIT_REF_NAME:$V_NUM bash -c "yarn test-ci --passWithNoTests"
    allow_failure: true
    after_script:
        - sudo chown -R gitlab-runner .
    tags:
        - rse-nds-builder

yarnbuild:
    stage: yarnbuild
    artifacts:
        untracked: true
    dependencies:
        - yarninstall
    script:
        - docker login --username=$CI_REGISTRY_USER --password=$CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker pull $CARBON_URL/$CI_COMMIT_REF_NAME:$V_NUM
        - docker run -v $PWD:/app $CARBON_URL/$CI_COMMIT_REF_NAME:$V_NUM bash -c "yarn run build"
    after_script:
        - sudo chown -R gitlab-runner .
    tags:
        - rse-nds-builder

nginxbuild:
    stage: nginxbuild
    dependencies: 
        - yarnbuild
    before_script:
        - sudo systemctl stop docker
        - sudo rm -rf /var/lib/docker
        - sudo systemctl start docker
        - sudo docker rmi -f $NGINX_URL/$CI_COMMIT_REF_NAME:$V_NUM
    script:
        - echo $CI_COMMIT_SHA > git.txt
        - docker build -f Dockerfile-nginx -t $NGINX_URL/$CI_COMMIT_REF_NAME:$V_NUM .
        - docker login --username=$CI_REGISTRY_USER --password=$CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker push $NGINX_URL/$CI_COMMIT_REF_NAME:$V_NUM
    after_script:
        - sudo chown -R gitlab-runner .
    tags:
        - rse-nds-builder
